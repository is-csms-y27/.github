# Лабораторная 3

## Отрабатываемый материал

Npgsql, Postgres, serialization, options, ASP.NET, hosted service, HTTP, gRPC

## Задача

- Реализовать сервис товаров с gRPC API и HTTP гейтвей к нему.
- Сервис товаров должен иметь гексагональную архитектуру.

## Задание 1

Реализовать репозитории, миграцию и сервис для предоставленной [схемы данных](lab-3-task-1.sql).

### Функциональные требования

- Репозиторий товаров должен предоставлять функционал
    - Создания товаров
    - Пагинированного поиска товаров (фильтрация по: идентификаторам, минимальной и максимальной цене, подстроке в имени
      товара)
- Репозиторий заказов должен предоставлять функционал
    - Создания заказа
    - Изменения статуса заказа
    - Пагинированного поиска заказов (фильтрация по: идентификаторам, статусу, автору)
- Репозиторий позиций заказов должен предоставлять функционал
    - Добавление позиции заказа
    - Удаление позиции из заказа (soft delete)
    - Пагинированного поиска по позициям заказов (фильтрация по: идентификаторам заказов, идентификаторам товаров,
      признаку удаления [bool?])
- Репозиторий истории заказов должен предоставлять функционал
    - Добавление записи в историю заказа
    - Пагинированного поиска по истории заказов (фильтрация по: идентификаторам заказа, типу истории)
- Сервис товаров должен предоставлять функционал
    - Создания товаров
- Сервис заказов должен предоставлять функционал
    - Создания заказа
    - Добавления товаров в заказ (только для заказов в статусе `created`)
    - Удаление товаров из заказа (только для заказов в статусе `created`)
    - Перевод заказа в работу (статус `processing`)
    - Выполнение заказа (перевод в статус `completed`)
    - Отмену заказа (перевод в статус `cancelled`)
    - Пагинированного поиска по истории одного заказа
    - Все операции должны сопровождаться соответствующими записями в историю

### Нефункциональные требования

- Миграции должны быть реализованы через библиотеку FluentMigrator и SQL код
- Конфигурации базы данных должны быть получены через `Microsoft.Extensions.Options`
- Должны быть реализованы методы расширения для регистрации в DI миграций, репозиториев и подключений к базе данных
- Должен быть реализованы методы расширения для запуска миграций
- В репозитории истории заказов должна быть реализована полиморфная сериализация/десериализация записей истории
- Репозитории должны быть реализованы через SQL запросы и библиотеку Npgsql
- Операции сервиса, подразумевающие несколько запросов в базу данных, должны использовать транзакции
- Должен быть реализован метод расширения для регистрации сервисов в DI
- Конфигурация базы данных должна получаться из провайдера, реализованного в Задании 2

### Тестовые сценарии

В качестве тестового сценария реализуйте отдельное консольное приложение, собирающее ServiceCollection с реализованными
ранее сервисами, подключенной конфигурацией внешнего сервиса. Данные для подключения внешнего сервиса конфигураций
должны находится в JSON файле, также подключаемым в конфигурации.

Проект с данным сценарием должен находиться в solution папке тестов.

Для вашего сценария должна использоваться **отдельная** база данных (не та, что использует сервис конфигураций), для
этого вам будет необходимо добавить в docker compose файл ещё один сервис с базой данных.

Сценарий подразумевает

- Загрузку конфигураций через обслуживающий сервис
- Создание нескольких товаров
- Создание заказа
- Добавления товаров в заказ
- Удаление одного товара из заказа
- Перевод заказа в работу
- Выполнение заказа
- Вывод в консоль всей истории заказа

Работоспособность данного сценария вам необходимо будет продемонстрировать преподавателю на защите лабораторной.

## Задание 2

- Реализовать Presentation слой с использованием gRPC.

## Функциональные требования

- Presentation слой должен предоставлять весь функционал, реализуемый сервисом заказов

## Нефункциональные требования

- конфигурация клиента должна происходить через Options
- модели gRPC API, подразумевающие полиморфизм, должны быть реализованы через `oneof`
- должен быть реализован серверный Interceptor, отдающий сообщения об ошибках в определённом формате
- все конфигурации должны получаться посредствам провайдеров, реализованных в Лабораторной 2
- должно быть реализовано получение изначальной конфигурации и её последующая актуализация при помощи ASP.NET 
- код в Program.cs не должен явно выполнять какие-либо операции, он должен состоять только из настройки
  `builder.Services`, `builder.Configuration`, `app`

## Задание 3

Реализовать HTTP гейтвей (отдельный сервис) над gRPC сервисом.

## Нефункциональные требования

- HTTP гейтвей должен иметь Swagger документацию, аннотированную возможными возвращаемыми кодами
- модели, подразумевающие полиморфизм, в API HTTP гейтвея должны быть реализованы **НЕ** в виде `oneof`, а с использованием наследования
- Swagger документация должна корректно отображать полиморфные модели
- в HTTP гейтвее должен быть реализован middleware, для преобразования gRPC эксепшенов в конкретные HTTP коды
- модели HTTP гейтвея не должны в каком-либо виде завязываться на Proto модели
- все конфигурации должны получаться посредствам провайдеров, реализованных в Лабораторной 2
- должно быть реализовано получение изначальной конфигурации и её последующая актуализация при помощи ASP.NET
- код в Program.cs не должен явно выполнять какие-либо операции, он должен состоять только из настройки
  `builder.Services`, `builder.Configuration`, `app`